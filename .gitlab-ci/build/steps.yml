### Build Application ###
.build:
  when: on_success
  stage: Build
  allow_failure: false
  script:
    - echo $AZURE_REGISTRY_PASSWORD | docker login -u $AZURE_REGISTRY_USER --password-stdin $AZURE_REGISTRY_URL
    - export DOCKER_TAG=$AZURE_REGISTRY_URL/$CI_PROJECT_NAMESPACE/$IMAGE_NAME:$CI_PIPELINE_ID-$CI_COMMIT_SHORT_SHA
    - export DOCKER_TAG_LATEST=$AZURE_REGISTRY_URL/$CI_PROJECT_NAMESPACE/$IMAGE_NAME:latest
    - docker pull $DOCKER_TAG || true
    - docker build --cache-from $DOCKER_TAG --tag $DOCKER_TAG --tag $DOCKER_TAG_LATEST .
    - docker push $DOCKER_TAG
    - if [[ $CI_PIPELINE_SOURCE != 'merge_request_event' ]]; then docker push $DOCKER_TAG_LATEST; fi

build_prod:
  extends:
    - .build
    - .environment_prod

build_staging:
  extends:
    - .build
    - .environment_staging

build_dev:
  extends:
    - .build
    - .environment_dev
  variables:
    CONTENT_API_BASE_URL: https://dev.api.aldi.amplicade.com/umbraco
    AUTH_API_BASE_URL: https://dev.api.aldi.amplicade.com/auth
    ADBE_API_BASE_URL: https://dev.api.aldi.amplicade.com/ad-be
