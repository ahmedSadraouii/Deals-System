### Build Application ###
.build:
  when: on_success
  stage: Build
  allow_failure: false
  script:
    - echo $AZURE_REGISTRY_PASSWORD | docker login -u $AZURE_REGISTRY_USER --password-stdin $AZURE_REGISTRY_URL
    - export DOCKER_TAG=$AZURE_REGISTRY_URL/$CI_PROJECT_NAMESPACE/$IMAGE_NAME:$CI_PIPELINE_ID-$CI_COMMIT_SHORT_SHA
    - export DOCKER_TAG_LATEST=$AZURE_REGISTRY_URL/$CI_PROJECT_NAMESPACE/$IMAGE_NAME:latest
    - docker pull $DOCKER_TAG || true
    - docker build --cache-from $DOCKER_TAG --build-arg NEXT_PUBLIC_ADOBE_SCRIPT=${NEXT_PUBLIC_ADOBE_SCRIPT} --build-arg NEXT_PUBLIC_IMAGE_REMOTE_HOSTNAME=${NEXT_PUBLIC_IMAGE_REMOTE_HOSTNAME} --tag $DOCKER_TAG --tag $DOCKER_TAG_LATEST .
    - docker push $DOCKER_TAG
    - if [[ $CI_PIPELINE_SOURCE != 'merge_request_event' ]]; then docker push $DOCKER_TAG_LATEST; fi

build_prod:
  extends:
    - .build
    - .environment_prod
  variables:
    NEXT_PUBLIC_ADOBE_SCRIPT: https://assets.adobedtm.com/1a449bc36397/626d47f555ca/launch-20f5b14e58a4.min.js
    NEXT_PUBLIC_IMAGE_REMOTE_HOSTNAME: http://ad-umbraco-cms-deliveryapi/umbraco

build_dev:
  extends:
    - .build
    - .environment_dev
  variables:
    NEXT_PUBLIC_ADOBE_SCRIPT: https://assets.adobedtm.com/1a449bc36397/626d47f555ca/launch-c5cc8581b00c-staging.min.js
    NEXT_PUBLIC_IMAGE_REMOTE_HOSTNAME: https://dev.api.aldi.amplicade.com/umbraco
