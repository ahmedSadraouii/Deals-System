### Build Application ###
.build_application:
  when: on_success
  stage: Build
  allow_failure: false
  script:
    - echo $AZURE_REGISTRY_PASSWORD | docker login -u $AZURE_REGISTRY_USER --password-stdin $AZURE_REGISTRY_URL
    - export DOCKER_TAG=$AZURE_REGISTRY_URL/$CI_PROJECT_NAMESPACE/$IMAGE_NAME:$CI_PIPELINE_ID-$CI_COMMIT_SHORT_SHA
    - export DOCKER_TAG_LATEST=$AZURE_REGISTRY_URL/$CI_PROJECT_NAMESPACE/$IMAGE_NAME:latest
    - docker pull $DOCKER_TAG || true
    - docker build --cache-from $DOCKER_TAG --tag $DOCKER_TAG --tag $DOCKER_TAG_LATEST .
    - docker push $DOCKER_TAG
    - if [[ $CI_PIPELINE_SOURCE != 'merge_request_event' ]]; then docker push $DOCKER_TAG_LATEST; fi
  
build_application_prod:
  extends:
    - .build_application
    - .environment_prod

build_application_staging:
  extends:
    - .build_application
    - .environment_staging

build_application_dev:
  extends:
    - .build_application
    - .environment_dev